. ./scripts/utils.sh

USERAGENT='"Mozilla/5.0 \(Windows NT 10.0; rv:100.0\) Gecko/20100101 Firefox/100.0"'

## Init analice URL
function analice_URL(){
    URL=$1
    log_info "Analyzing web: ${URL}"
    check_alive $URL
    get_ip $URL
    whatweb_analyce $URL
    ffuf_analyce $URL
    nuclei_analyce $URL
}

function check_alive(){
    url=$1
    # Check if the URL is active
    curl -Is $url
    if [ $? -eq 0 ]; then
        log_ok "URL is alive"
    else
        log_warning "URL is not alive"
        exit 1;
    fi
}

function get_ip(){
    ip=$(host $url | awk '/has address/ {print $4}' | head -n 1)
    log_info "IP: $ip"
}

function whatweb_analyce(){
    echo -e "${greenColour}\n[*] Whatweb${endColour}"
    url=$1
    host_name=$(echo $url | sed -e 's/[^/]*\/\/\([^@]*@\)\?\([^:/]*\).*/\2/')
    OPFILE="--log-verbose ${TOOL_PATH}/whatweb_${host_name}"

    COMMAND="whatweb --user-agent ${USERAGENT} -v -a 3 ${OPFILE} ${url}"
    echo -e "${purpleColour}command${endColour}$ ${COMMAND}"
    echo -e "<------------------------------->\n";
    eval $COMMAND
}

function ffuf_analyce(){
    echo -e "${greenColour}\n[*] FFuF ${endColour}"
    url=$1
    host_name=$(echo $url | sed -e 's/[^/]*\/\/\([^@]*@\)\?\([^:/]*\).*/\2/')
    WORDLIST_PATH="/usr/share/wordlists"
    WORDLIST="-w ${WORDLIST_PATH}/fuzz.txt "
    EXTENSIONS="-e conf,config,bak,backup,swp,old,db,sql,asp,aspx,aspx~,asp~,py,py~,rb,rb~,php,php~,bak,bkp,cache,cgi,conf,csv,html,inc,jar,js,json,jsp,jsp~,lock,log,rar,old,sql,sql.gz,sql.zip,sql.tar.gz,sql~,swp,swp~,tar,tar.bz2,tar.gz,txt,wadl,zip,.log,.xml,.js.,.json"
    RECURSION="-recursion -recursion-depth 2"
    REPLAY_PROXY="-replay-proxy http://127.0.0.1:8080"
    THREADS="-t 10"
    USR="-H 'User-Agent: Mozilla/5.0 \(Windows NT 10.0; rv:100.0\) Gecko/20100101 Firefox/100.0'" 
    OPFILE="-o ${TOOL_PATH}/ffuf_${host_name}.html -of html"

    COMMAND="ffuf -r ${RECURSION} ${REPLAY_PROXY} ${WORDLIST} -ac ${USR} ${THREADS} ${OPFILE} -u ${url}/FUZZ"
    echo -e "${purpleColour}command${endColour}$ ${COMMAND}"
    echo -e "<------------------------------->\n";
    eval $COMMAND

}

function nuclei_analyce(){
    echo -e "${greenColour}\n[*] Nuclei ${endColour}"
    url=$1
    host_name=$(echo $url | sed -e 's/[^/]*\/\/\([^@]*@\)\?\([^:/]*\).*/\2/')
    USR="-H 'User-Agent: Mozilla/5.0 \(Windows NT 10.0; rv:100.0\) Gecko/20100101 Firefox/100.0'" 
    OPFILE="-markdown-export ${TOOL_PATH}/nuclei_${host_name}"

    COMMAND="nuclei ${USR} -follow-redirects -disable-update-check ${OPFILE} -target ${url}"
    echo -e "${purpleColour}command${endColour}$ ${COMMAND}"
    echo -e "<------------------------------->\n";
    eval $COMMAND
}

function testssl_analyce(){
    COMMAND="/opt/testssl.sh/testssl.sh "
    echo -e "${purpleColour}command${endColour}$ ${COMMAND}"
    echo -e "<------------------------------->\n";
    eval $COMMAND
}